@using LocalFileWebService.Models
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var folder_path = Request.QueryString["p"];
    var folders = ViewBag.Folders as List<Folder> ?? new List<Folder>();
    var sources = ViewBag.sources as List<Source> ?? new List<Source>();
}

<style>
    .view-video-btn {
        cursor: pointer;
    }

    .floating-container-layer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(52, 52, 52, 0.50);
        box-shadow: 0 0 10px 0 rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: center;
        align-items: end;
        z-index: 1000;
    }

    .play-media-container {
        width: 100%;
        max-width: 1000px;
        height: 100%;
        max-height: 800px;
        background-color: #202427;
        bottom: 0;
        border-radius: 10px 10px 0 0;
        padding: 10px;
    }

    .play-media-container > video {
        width: 100%;
        aspect-ratio: 16/9;
        cursor: pointer;
    }

    .conatainer-display-hidden {
        display: none !important;
    }

    .conatainer-display-show {
        display: flex !important;
    }

    .file-display-name {
        white-space: nowrap; /* Ngăn xuống dòng */
        overflow: hidden; /* Ẩn nội dung thừa */
        text-overflow: ellipsis; /* Hiển thị dấu ba chấm cho nội dung bị cắt */
        margin: 5px 0 5px 0;
        text-align: left;
    }

    .folder-name:active {
        color: white;
    }

    .folder-name:hover {
        color: white;
        text-decoration: none !important;
    }

    .create-new-folder-container {
        width: 100%;
        max-width: 550px;
        height: 100%;
        max-height: 190px;
        background-color: #202427;
        border-radius: 10px 10px 0 0;
        padding: 20px;
        color: white;
    }

    #contextMenu ul {
        padding: 5px;
        background-color: #f9f9f9;
    }

    #contextMenu ul li {
        padding: 8px 12px;
    }

    #contextMenu ul li a {
        text-decoration: none;
        color: black;
    }

    #contextMenu ul li:hover {
        background-color: #e8e8e8;
    }

    .show-img-thumbnail-container {
        width: 10rem;
        aspect-ratio: 1/1;
        overflow: hidden;
        cursor: pointer;
    }

    .show-img-thumbnail {
    }

    #zoom-image-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        cursor: grab;
        z-index: 1000;
    }

    #zoom-image-container button {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0;
        width: 30px;
        aspect-ratio: 1/1;
    }

    #zoom-image-view {
        position: absolute;
        max-width: 100%;
        max-height: 100%;
        transform-origin: center center;
        transition: transform 0.1s ease;
    }
</style>

<div class="position-relative d-block p-3 rounded" style="background-color: var(--white-gray-color)">
    <h6 class="title rounded directory-show text-white m-0">
        <a href="/Home/Index" class="text-decoration-none text-white">Root</a>
        @{
            if (!string.IsNullOrEmpty(folder_path))
            {
                string[] folder_path_list = folder_path.Split('/');
                var path = "";
                for (int idx = 0; idx < folder_path_list.Length; idx++)
                {
                    if (idx == 0)
                    {
                        path = folder_path_list[idx];
                    }
                    else
                    {
                        path += $"/{folder_path_list[idx]}";
                    }
                    <span>
                        > <a href="/Home/Index?p=@path" class="text-decoration-none text-white">@folder_path_list[idx]</a>
                    </span>
                }
            }
        }
    </h6>
</div>

@if (folders.Count > 0)
{
    <h4 class="title text-white mt-2">Folders</h4>
    <div class="d-flex flex-row flex-wrap foder-show-body" style="margin-top: 2rem; margin-bottom: 2rem; gap: 10px;">
        @foreach (var folder in folders)
        {
            <a href="?p=@(string.IsNullOrEmpty(folder_path) ? folder.FolderName : $"{folder_path}/{folder.FolderName}")" class="context-menu-target" data-item-id="folder-@folder.FolderName-@folder.FolderId">
                <div class="d-flex flex-row p-2 flex-grow-0 align-items-center folder-container rounded border" style="width: 13rem; gap: 10px">
                    @if (string.IsNullOrEmpty(folder.FolderIconUrl))
                    {
                        <svg width="30px" height="30px" viewBox="0 0 1024 1024" class="icon" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M810.665 269.333v-24.889c0-27.467-22.288-49.777-49.777-49.777H437.333v-24.89c0-27.467-22.288-49.777-49.779-49.777H263.11c-27.489 0-49.777 22.31-49.777 49.777v99.556h597.332z" fill="#2577FF" /><path d="M885.332 269.333H399.999V232c0-41.203-33.431-74.667-74.667-74.667H138.667C97.431 157.333 64 190.798 64 232v597.333C64 870.6 97.431 904 138.667 904h746.665c41.235 0 74.666-33.4 74.666-74.667V344c0-41.202-33.431-74.667-74.666-74.667z" fill="#FCB814" /><path d="M344 209.224v60.109h55.528c10.588-82.956-28.514-102.28-62.733-110.843A181.619 181.619 0 0 1 344 209.224zM896.794 270.491C901.296 280.096 904 290.7 904 302v485.334C904 828.6 870.566 862 829.332 862H82.665c-3.93 0-7.71-0.571-11.477-1.156C83.092 886.282 108.73 904 138.665 904h746.667C926.566 904 960 870.6 960 829.333V344c0-37.278-27.454-67.953-63.206-73.509z" fill="" /></svg>
                    }
                    else
                    {
                        <img src="/Home/GetFile/3" class="nav_icon folder-icon" alt="icon">
                    }
                    <h6 class="folder-name text-light m-0">@folder.FolderName</h6>
                </div>
            </a>
        }

    </div>
    <hr style="border-top: 1px solid var(--white-gray-color); " />
}
else
{
    <br />
}

<div class="d-flex flex-row justify-content-between">
    <h4 class="title text-white">Files</h4>
    <div class="">
        <label class="switch text-white" for="my-checkbox">Auto Play</label>
        <input type="checkbox" name="auto-play-checkbox" id="auto-play-checkbox">
    </div>
</div>
<div class="d-flex flex-row flex-wrap" id="card-container" style="margin-top: 2rem; margin-bottom: 2rem; gap: 10px;">
    @if (sources.Count > 0)
    {
        foreach (var source in sources)
        {

            <div class="card bg-dark border-0 context-menu-target" data-item-id="source-@source.SourceName-@source.SourceId">
                @if (source.SourceType.Contains("image"))
                {
                    <button class="show-img-thumbnail-container rounded border-0 p-0" onclick="onClickViewImg('/Home/GetFile/@(source.SourceId)')">
                        <img src="/Home/GetFile/@source.SourceId" class="card-img-top show-img-thumbnail" alt="...">
                    </button>
                }
                else if (source.SourceType.Contains("video"))
                {
                    <button class="mb-0 p-0 border-0 rounded view-video-btn" style="background-color: #343a40; width: 18rem;" onclick="onClickOpenViewVideo('/Home/GetFile/@source.SourceId', '@source.SourceName')">
                        <img src="/Home/GetVideoFileThumbnail/@source.SourceId" class="rounded card-img-top" alt="thumb">
                        <p class="text-white bg-dark m-0 position-absolute" style="font-size:.8rem; padding: 0 5px 0 5px; top: 5px; right: 5px;">@TimeSpan.FromSeconds(source.SourceLength).ToString(@"hh\:mm\:ss")</p>
                    </button>
                    <div class="d-flex flex-row align-items-center justify-content-between">
                        <p href="/Home/GetFile/@source.SourceId" class="file-display-name text-white flex-grow-1" style="font-size: .8rem; text-decoration: none;">@source.SourceName</p>

                    </div>

                }
                else if (source.SourceType.Contains("audio"))
                {
                    <audio controls class="rounded">
                        <source src="/Home/GetFile/@source.SourceId" type="audio/mpeg">
                        Your browser does not support the audio tag.
                    </audio>
                }
                else
                {
                    <div class="unsupported-file">
                        <svg ...></svg>
                        <p class="text-muted">Unsupported file type</p>
                    </div>
                }
            </div>

        }
    }
    else
    {
        <div class="d-flex align-items-center flex-column" style="width: 100%">
            <img src="~/Content/Image/empty-folder.png" alt="Folder Empty" style="width:13rem; aspect-ratio:1/1;" />
            <h6 class="text-muted">Folder Is Empty ...</h6>
        </div>
    }
</div>

<div class="floating-container-layer conatainer-display-hidden" id="view-media-container">
    <div class="play-media-container">
        <video controls autoplay class="rounded" id="video-source-element">
            <source src="" type="video/mp4">
        </video>
        <h4 id="view-video-source-name" class="text-white mt-1"></h4>
    </div>
</div>

<div class="floating-container-layer justify-content-center align-items-center conatainer-display-hidden" id="create-new-folder-container">
    <div class="create-new-folder-container rounded border">
        <form action="/Home/CreateFolder" method="post" class="">
            <label for="folder-name" class="col-form-label"><strong>Folder Name</strong></label>
            <input type="text" name="folder-name" id="folder-name" class="form-control" required>
            <input type="hidden" name="folder-path" value="@folder_path">
            <div class="mt-3">
                <button type="submit" class="btn btn-primary">Create Folder</button>
            </div>
        </form>
    </div>
</div>

<div id="contextMenu" class="rounded" style="display:none; position:absolute; z-index:1000; background:white; border:1px solid #ccc;">
    <ul style="list-style:none; margin:0; padding:0;">
        <li><a href="#" id="actionOption1" class="d-flex row align-items-center m-1" style="gap: 5px;"><span class="material-icons">delete</span> Delete</a></li>
        <li><a href="#" id="actionOption2" class="d-flex row align-items-center m-1" style="gap: 5px;"><span class="material-icons">info</span> Properties</a></li>
    </ul>
</div>

<div id="zoom-image-container">
    <button class="position-absolute bg-transparent border-0 text-white" style="top: 10px; right: 10px;" onclick="onClickCloseViewImg()"><span class="material-icons">close</span></button>
    <img src="/Home/GetFile/20" alt="Zoomable Image" id="zoom-image-view">
</div>

<script>
    const container = document.getElementById('zoom-image-container');
    const img = document.getElementById('zoom-image-view');

    let scale = 1;
    let startX = 0, startY = 0;
    let translateX = 0, translateY = 0;
    let isDragging = false;

    // Zoom with mouse wheel
    container.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        scale = Math.min(Math.max(scale + delta, 0.5), 5); // Limit zoom between 0.5x and 5x
        img.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    });

    // Drag to move image
    container.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
        container.style.cursor = 'grabbing';
    });

    container.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        img.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    });

    container.addEventListener('mouseup', () => {
        isDragging = false;
        container.style.cursor = 'grab';
    });

    container.addEventListener('mouseleave', () => {
        isDragging = false;
        container.style.cursor = 'grab';
    });

    function onClickCloseViewImg() {
        container.style.display = 'none';
    }

    function onClickViewImg(url) {
        img.src = url;
        container.style.display = 'flex';
    }
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const contextMenu = document.getElementById("contextMenu");
        let currentElementId = null;

        // Gắn sự kiện contextmenu (chuột phải) cho tất cả các phần tử có class 'context-menu-target'
        document.querySelectorAll(".context-menu-target").forEach(element => {
            element.addEventListener("contextmenu", function (event) {
                event.preventDefault();

                // Lưu ID hoặc thông tin phần tử được nhấp
                currentElementId = this.getAttribute("data-item-id");

                // Hiển thị menu tại vị trí con trỏ
                contextMenu.style.display = "block";
                contextMenu.style.left = event.pageX + "px";
                contextMenu.style.top = event.pageY - 60 + "px";
            });
        });

        // Ẩn menu khi nhấp chuột bên ngoài
        document.addEventListener("click", function (event) {
            if (event.target.closest("#contextMenu") == null) {
                contextMenu.style.display = "none";
            }
        });

        // Xử lý các hành động trong menu
        document.getElementById("actionOption1").addEventListener("click", function () {
            const [type_, name_, id_] = currentElementId.split("-");
            deleteFolder(id_, name_, type_);
        });

        document.getElementById("actionOption2").addEventListener("click", function () {
            alert(`Option 2 selected for item ${currentElementId}`);
            contextMenu.style.display = "none";
        });
    });

    function deleteFolder(id_, name_, type_) {
        if (confirm(`Are you sure you want to delete [${name_}]?`)) {
            $.post("/Home/DeleteFolder", { id: id_, name: name_, type: type_ })
                .done(function (response) {
                    if (response.success) {
                        alert(response.message);
                    } else {
                        alert("Error: " + response.message);
                    }
                })
                .fail(function () {
                    alert("Request failed!");
                });
        }
    }

</script>

<script>
    function onClickOpenViewVideo(url, name) {
        const videoElement = document.getElementById("video-source-element");
        if (document.getElementById("auto-play-checkbox").checked) {
            videoElement.autoplay = true;
        } else {
            videoElement.autoplay = false;
        }
        videoElement.src = url;
        videoElement.load();
        document.querySelector("#view-video-source-name").innerText = name;

        const container = document.querySelector("#view-media-container");
        container.classList.remove("conatainer-display-hidden");
        container.classList.add("conatainer-display-show");

        container.addEventListener("click", (e) => {
            if (!e.target.closest(".play-media-container")) {
                container.classList.remove("conatainer-display-show");
                container.classList.add("conatainer-display-hidden");
                document.getElementById("video-source-element").pause();
            }
        });
    }
</script>
